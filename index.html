<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="theme-color" content="#0d1424"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Chore Quest"/>
<link rel="manifest" href="manifest.json"/>
<link rel="apple-touch-icon" href="icon-192.png"/>
<title>Chore Quest</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fredoka+One&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
:root{
  --navy:#0d1424; --navy2:#141c2e; --navy3:#1b2540; --navy4:#232e4a;
  --border:#2a3854;
  --blue:#4fc3f7; --green:#69f0ae; --green-dark:#00c853;
  --yellow:#ffd740; --purple:#b388ff; --orange:#ffb74d; --red:#ff6b6b;
  --text:#e8edf8; --muted:#6b7fa3;
  --font:'Nunito',sans-serif; --display:'Fredoka One',cursive;
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bot:env(safe-area-inset-bottom,0px);
  --hdr-h:58px; --tab-h:64px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overscroll-behavior:none}
body{
  background:var(--navy);color:var(--text);font-family:var(--font);
  background-image:
    radial-gradient(ellipse 80% 40% at 15% 0%,rgba(79,195,247,0.07) 0%,transparent 55%),
    radial-gradient(ellipse 60% 40% at 85% 100%,rgba(179,136,255,0.07) 0%,transparent 55%);
}
.hdr{position:fixed;top:0;left:0;right:0;z-index:200;padding-top:var(--safe-top);background:rgba(13,20,36,0.94);border-bottom:1px solid var(--border);backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);}
.hdr-inner{display:flex;align-items:center;gap:8px;padding:0 12px;height:var(--hdr-h)}
.logo{font-family:var(--display);font-size:20px;color:var(--blue);white-space:nowrap;flex-shrink:0}
.logo b{color:var(--yellow)}
.kid-scroller{flex:1;overflow-x:auto;display:flex;gap:6px;align-items:center;scrollbar-width:none;-ms-overflow-style:none;}
.kid-scroller::-webkit-scrollbar{display:none}
.kid-tab{display:flex;align-items:center;gap:4px;flex-shrink:0;background:var(--navy3);border:1.5px solid var(--border);border-radius:20px;padding:5px 10px;cursor:pointer;transition:all .18s;}
.kid-tab.active{background:rgba(79,195,247,0.12);border-color:var(--blue)}
.kid-tab input{background:transparent;border:none;outline:none;color:var(--text);font-family:var(--font);font-size:13px;font-weight:700;width:64px;}
.kid-tab.active input{color:var(--blue)}
.kid-tab button{background:transparent;border:none;cursor:pointer;color:var(--muted);font-size:10px;padding:0 2px;line-height:1;}
.btn-add-kid{flex-shrink:0;background:transparent;border:1.5px dashed var(--border);color:var(--muted);font-family:var(--font);font-size:11px;font-weight:700;padding:5px 9px;border-radius:20px;cursor:pointer;white-space:nowrap;}
.hdr-right{display:flex;align-items:center;gap:5px;flex-shrink:0}
.sync-pill{display:flex;align-items:center;gap:5px;background:var(--navy3);border:1px solid var(--border);border-radius:8px;padding:4px 8px;font-size:9px;font-weight:800;color:var(--muted);white-space:nowrap;flex-shrink:0;transition:all .3s;}
.sync-dot{width:6px;height:6px;border-radius:50%;background:var(--muted);flex-shrink:0;transition:all .3s}
.sync-pill.synced{color:var(--green);border-color:rgba(105,240,174,0.28)}
.sync-pill.synced .sync-dot{background:var(--green);box-shadow:0 0 6px var(--green)}
.sync-pill.syncing{color:var(--yellow);border-color:rgba(255,215,64,0.28);animation:syncPulse 1.2s ease-in-out infinite}
.sync-pill.syncing .sync-dot{background:var(--yellow)}
.sync-pill.error{color:var(--red);border-color:rgba(255,107,107,0.28)}
.sync-pill.error .sync-dot{background:var(--red)}
@keyframes syncPulse{0%,100%{opacity:1}50%{opacity:.5}}
.icon-btn{width:36px;height:36px;border-radius:10px;background:var(--navy3);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:17px;color:var(--muted);flex-shrink:0;}
.content{position:fixed;top:calc(var(--safe-top) + var(--hdr-h));left:0;right:0;bottom:calc(var(--safe-bot) + var(--tab-h));overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;}
.tab-pane{display:none;padding:12px 12px 24px;flex-direction:column;gap:11px}
.tab-pane.active{display:flex}
.tabbar{position:fixed;bottom:0;left:0;right:0;z-index:200;padding-bottom:var(--safe-bot);background:rgba(13,20,36,0.96);border-top:1px solid var(--border);backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);display:flex;}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;padding:8px 4px;height:var(--tab-h);cursor:pointer;border:none;background:transparent;color:var(--muted);font-family:var(--font);font-size:10px;font-weight:700;letter-spacing:.3px;text-transform:uppercase;transition:color .15s;position:relative;}
.tab-icon{font-size:22px;line-height:1;transition:transform .2s}
.tab.active{color:var(--blue)}
.tab.active .tab-icon{transform:scale(1.12)}
.tab::before{content:'';position:absolute;top:0;left:20%;right:20%;height:2px;background:var(--blue);border-radius:0 0 2px 2px;transform:scaleX(0);transition:transform .2s;}
.tab.active::before{transform:scaleX(1)}
.section{background:var(--navy2);border:1px solid var(--border);border-radius:15px;overflow:hidden}
.sec-hdr{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;border-bottom:1px solid var(--border);cursor:pointer;user-select:none;}
.sec-title{display:flex;align-items:center;gap:8px;font-family:var(--display);font-size:15px}
.dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.collapse-icon{margin-left:5px;display:inline-block;flex-shrink:0;vertical-align:middle;width:0;height:0;border-left:4px solid transparent;border-right:4px solid transparent;border-top:5px solid var(--muted);transition:transform .22s;}
.section.collapsed .collapse-icon{transform:rotate(-90deg)}
.sec-body{padding:9px 11px;display:flex;flex-direction:column;gap:6px}
.sec-tip{padding:3px 15px 10px;font-size:10.5px;color:var(--muted)}
.section.collapsed .sec-body,.section.collapsed .sec-tip{display:none}
.btn-add{background:transparent;border:1.5px dashed var(--border);color:var(--muted);font-family:var(--font);font-size:11px;font-weight:700;padding:5px 12px;border-radius:7px;cursor:pointer;}
.chore-card{background:var(--navy3);border:1px solid var(--border);border-radius:11px;overflow:hidden;animation:fadeIn .2s ease;}
.chore-card.done-today{background:linear-gradient(90deg,rgba(105,240,174,0.06),var(--navy3));border-color:rgba(105,240,174,0.22)}
.chore-card.off-day{opacity:.42}
.chore-card.drag-over,.reward-row.drag-over{border-color:var(--blue);background:rgba(79,195,247,0.07)}
.chore-card.dragging,.reward-row.dragging{opacity:.35}
@keyframes fadeIn{from{opacity:0;transform:translateY(-3px)}to{opacity:1;transform:translateY(0)}}
.chore-row{display:flex;align-items:center;gap:7px;padding:9px 10px}
.drag-handle{cursor:grab;color:var(--muted);font-size:14px;padding:0 2px;flex-shrink:0;user-select:none;line-height:1;}
.drag-handle:active{cursor:grabbing}
.c-icon{font-size:17px;flex-shrink:0}
.c-name{flex:1;min-width:0;background:transparent;border:none;outline:none;color:var(--text);font-family:var(--font);font-size:14px;font-weight:600;}
.c-name::placeholder{color:var(--muted);font-weight:400}
.c-name.struck{text-decoration:line-through;opacity:.5}
.tok-badge{display:flex;align-items:center;gap:2px;background:rgba(255,215,64,0.09);border:1px solid rgba(255,215,64,0.18);border-radius:6px;padding:3px 5px;flex-shrink:0;}
.tok-badge input{width:28px;background:transparent;border:none;outline:none;color:var(--yellow);font-family:var(--font);font-size:12px;font-weight:800;text-align:center;}
.check-btn{width:38px;height:38px;border-radius:50%;border:2px solid var(--border);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:15px;transition:all .18s;color:transparent;}
.check-btn:active:not([disabled]){transform:scale(.88)}
.check-btn.ticked{border-color:var(--green);background:var(--green);color:#0a2a1a;animation:pop .28s ease}
.check-btn[disabled]{opacity:.32;cursor:default}
@keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
.ic-btn{width:34px;height:34px;border-radius:8px;border:1px solid var(--border);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;color:var(--muted);}
.ic-btn.del:active{background:rgba(255,80,80,0.12);border-color:rgba(255,80,80,0.4);color:var(--red)}
.ic-btn.undo:active{background:rgba(79,195,247,0.08);border-color:rgba(79,195,247,0.3);color:var(--blue)}
.day-row{display:flex;gap:4px;padding:3px 10px 8px;align-items:center;flex-wrap:wrap}
.day-btn{width:30px;height:30px;border-radius:6px;border:1px solid var(--border);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;font-family:var(--font);color:var(--muted);}
.day-btn.on{background:rgba(79,195,247,0.14);border-color:var(--blue);color:var(--blue)}
.day-btn.today-ring{box-shadow:0 0 0 2px var(--yellow)}
.off-label{font-size:10px;color:var(--muted);font-weight:700;margin-left:4px}
.reward-row{display:flex;align-items:center;gap:7px;background:var(--navy3);border:1px solid var(--border);border-radius:11px;padding:9px 10px;animation:fadeIn .2s ease;}
.r-name{flex:1;min-width:0;background:transparent;border:none;outline:none;color:var(--text);font-family:var(--font);font-size:14px;font-weight:600;}
.r-name::placeholder{color:var(--muted);font-weight:400}
.cost-badge{display:flex;align-items:center;gap:3px;background:rgba(179,136,255,0.09);border:1px solid rgba(179,136,255,0.2);border-radius:6px;padding:3px 6px;flex-shrink:0}
.cost-badge input{width:48px;background:transparent;border:none;outline:none;color:var(--purple);font-family:var(--font);font-size:13px;font-weight:800;text-align:center}
.redeem-btn{background:linear-gradient(135deg,var(--purple),#7c4dff);color:#fff;font-family:var(--font);font-size:12px;font-weight:800;border:none;border-radius:8px;padding:9px 12px;cursor:pointer;flex-shrink:0;white-space:nowrap;}
.wallet-hero{background:var(--navy2);border:1px solid var(--border);border-radius:18px;padding:20px 16px 16px;display:flex;flex-direction:column;align-items:center;gap:4px;}
.kid-label{font-family:var(--display);font-size:16px;color:var(--muted);margin-bottom:10px;text-align:center}
.tok-top{display:flex;align-items:center;justify-content:center;gap:24px;width:100%}
.tok-coin{width:108px;height:108px;border-radius:50%;background:conic-gradient(from 0deg,#ffd740,#ffab00,#ffe57f,#ffd740);display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 0 28px rgba(255,215,64,0.28),inset 0 2px 4px rgba(255,255,255,0.3);position:relative;flex-shrink:0;}
.tok-coin::before{content:'';position:absolute;inset:6px;border-radius:50%;background:linear-gradient(135deg,#ffcc00,#ff8f00);box-shadow:inset 0 2px 4px rgba(0,0,0,0.3)}
.tok-num{font-family:var(--display);font-size:31px;color:#4a2800;position:relative;z-index:1;line-height:1}
.tok-lbl{font-size:8px;font-weight:800;color:#6b3a00;letter-spacing:1px;position:relative;z-index:1}
.streak-box{display:flex;flex-direction:column;align-items:center;gap:3px}
.s-fire{font-size:28px;line-height:1}
.s-num{font-family:var(--display);font-size:26px;color:var(--orange);line-height:1}
.s-lbl{font-size:9px;font-weight:700;color:var(--muted);letter-spacing:.5px;text-transform:uppercase}
.s-best{font-size:9px;color:var(--muted)}
.no-streak .s-fire{filter:grayscale(1);opacity:.3}
.no-streak .s-num{color:var(--muted)}
.goal-box{margin-top:10px;background:var(--navy3);border:1px solid var(--border);border-radius:11px;padding:11px;width:100%}
.goal-pick-row{display:flex;align-items:center;gap:7px;margin-bottom:8px}
.goal-pick-label{font-size:10px;font-weight:800;color:var(--muted);letter-spacing:.4px;text-transform:uppercase;white-space:nowrap;flex-shrink:0}
.goal-select{flex:1;min-width:0;background:var(--navy4);border:1px solid var(--border);color:var(--text);font-family:var(--font);font-size:12px;font-weight:700;border-radius:7px;padding:6px 24px 6px 8px;outline:none;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236b7fa3'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;}
.goal-select option{background:#1b2540}
.goal-divider{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.goal-divider span{font-size:10px;font-weight:800;color:var(--muted);letter-spacing:.4px;text-transform:uppercase;white-space:nowrap}
.goal-divider::before,.goal-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.goal-row{display:flex;align-items:center;gap:7px;margin-bottom:7px}
.goal-icon{font-size:15px;flex-shrink:0}
.goal-name{flex:1;min-width:0;width:0;background:transparent;border:none;outline:none;color:var(--text);font-family:var(--font);font-size:12px;font-weight:700;}
.goal-name::placeholder{color:var(--muted);font-weight:400}
.goal-target{display:flex;align-items:center;gap:3px;flex-shrink:0}
.goal-target span{font-size:11px;color:var(--muted);font-weight:700;white-space:nowrap}
.goal-target input{width:72px;background:var(--navy4);border:1px solid var(--border);color:var(--yellow);font-family:var(--font);font-size:12px;font-weight:800;border-radius:5px;padding:4px 5px;text-align:center;outline:none;}
.goal-track{background:var(--navy4);border-radius:999px;height:9px;overflow:hidden}
.goal-fill{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--green-dark),var(--green));transition:width .4s ease}
.goal-pct{font-size:10px;font-weight:700;color:var(--muted);text-align:right;margin-top:3px}
.manual-card{background:var(--navy2);border:1px solid var(--border);border-radius:15px;padding:14px}
.manual-label{font-size:10px;font-weight:800;color:var(--muted);letter-spacing:.5px;text-transform:uppercase;margin-bottom:10px}
.manual-row{display:flex;gap:7px;align-items:center;flex-wrap:wrap}
.m-amt{width:60px;background:var(--navy3);border:1px solid var(--border);color:var(--text);font-family:var(--font);font-size:15px;font-weight:800;padding:9px 7px;border-radius:9px;text-align:center;outline:none;}
.m-amt:focus{border-color:var(--yellow)}
.m-note{flex:1;min-width:80px;background:var(--navy3);border:1px solid var(--border);color:var(--text);font-family:var(--font);font-size:13px;padding:9px 10px;border-radius:9px;outline:none;}
.m-note:focus{border-color:var(--blue)}
.m-note::placeholder{color:var(--muted)}
.m-add{background:linear-gradient(135deg,var(--green-dark),#00e676);color:#003020;font-family:var(--font);font-size:13px;font-weight:800;border:none;border-radius:9px;padding:9px 13px;cursor:pointer;flex-shrink:0}
.m-rem{background:rgba(255,80,80,0.12);border:1px solid rgba(255,80,80,0.28);color:var(--red);font-family:var(--font);font-size:13px;font-weight:800;border-radius:9px;padding:9px 13px;cursor:pointer;flex-shrink:0}
.m-undo{background:rgba(79,195,247,0.1);border:1px solid rgba(79,195,247,0.28);color:var(--blue);font-family:var(--font);font-size:13px;font-weight:800;border-radius:9px;padding:9px 12px;cursor:pointer;flex-shrink:0}
.hist-feed{display:flex;flex-direction:column;gap:4px;padding:9px 11px}
.hist-item{display:flex;align-items:center;gap:8px;padding:7px 9px;background:var(--navy3);border-radius:9px}
.h-amt{font-family:var(--display);font-size:13px;min-width:32px;text-align:right;flex-shrink:0}
.h-amt.pos{color:var(--green)}.h-amt.neg{color:var(--red)}
.h-note{flex:1;min-width:0;font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.h-time{font-size:9.5px;color:var(--muted);flex-shrink:0}
.hist-empty{padding:18px;text-align:center;color:var(--muted);font-size:12px}
.clear-btn{background:transparent;border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:10px;font-weight:700;border-radius:6px;padding:4px 9px;cursor:pointer;}
.charts-body{padding:9px 11px;display:flex;flex-direction:column;gap:8px}
.chart-wrap{position:relative;height:120px}
.chart-lbl{font-size:9.5px;color:var(--muted);font-weight:700;letter-spacing:.5px;text-transform:uppercase}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.72);z-index:1000;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);}
.overlay.open{display:flex}
.sheet{background:var(--navy2);border-top:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-height:88vh;overflow:hidden;display:flex;flex-direction:column;animation:sheetUp .25s ease;padding-bottom:var(--safe-bot);}
@keyframes sheetUp{from{transform:translateY(28%);opacity:.6}to{transform:translateY(0);opacity:1}}
.sheet-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:10px auto 0;flex-shrink:0}
.sheet-hdr{display:flex;align-items:center;justify-content:space-between;padding:13px 18px 11px;border-bottom:1px solid var(--border);flex-shrink:0}
.sheet-title{font-family:var(--display);font-size:19px}
.sheet-close{background:var(--navy3);border:1px solid var(--border);color:var(--muted);width:30px;height:30px;border-radius:8px;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;}
.sheet-body{padding:16px 18px 18px;overflow-y:auto;flex:1}
.sum-period{font-size:11px;color:var(--muted);font-weight:700;text-align:center;margin-bottom:14px}
.stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:18px}
.stat-card{background:var(--navy3);border:1px solid var(--border);border-radius:11px;padding:12px 8px;text-align:center}
.stat-val{font-family:var(--display);font-size:22px;margin-bottom:2px}
.stat-key{font-size:9px;font-weight:700;color:var(--muted);letter-spacing:.4px;text-transform:uppercase}
.sum-sec{font-size:10px;font-weight:800;color:var(--muted);letter-spacing:.5px;text-transform:uppercase;margin-bottom:7px}
.cs-row{display:flex;align-items:center;gap:9px;padding:6px 0;border-bottom:1px solid rgba(42,56,84,0.5)}
.cs-name{flex:1;min-width:0;font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cs-track{width:80px;height:6px;background:var(--navy4);border-radius:999px;overflow:hidden;flex-shrink:0}
.cs-fill{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--blue),var(--green))}
.cs-pct{font-size:10px;font-weight:800;width:30px;text-align:right;flex-shrink:0}
.cs-frac{font-size:9.5px;color:var(--muted);width:34px;text-align:right;flex-shrink:0}
.setting-row{display:flex;align-items:center;gap:13px;padding:14px 0;border-bottom:1px solid var(--border);cursor:pointer;}
.setting-row:last-child{border-bottom:none}
.setting-icon{font-size:22px;width:30px;text-align:center;flex-shrink:0}
.setting-info{flex:1}
.setting-label{font-size:15px;font-weight:700}
.setting-desc{font-size:12px;color:var(--muted);margin-top:2px}
.setting-row.danger .setting-label{color:var(--red)}
.setup-steps{display:flex;flex-direction:column;gap:13px}
.setup-step{background:var(--navy3);border:1px solid var(--border);border-radius:12px;padding:13px 14px}
.step-head{display:flex;align-items:center;gap:9px;margin-bottom:9px}
.step-num{width:22px;height:22px;border-radius:50%;background:var(--blue);color:#0a1a26;font-size:11px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.step-title{font-weight:800;font-size:13px}
.setup-step p{font-size:12px;color:var(--muted);line-height:1.65;margin-bottom:6px}
.setup-step p:last-child{margin-bottom:0}
.setup-step a{color:var(--blue);text-decoration:none}
.setup-step code{background:var(--navy4);border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-size:11px;color:var(--yellow);font-family:monospace}
.cfg-textarea{width:100%;height:130px;background:var(--navy4);border:1px solid var(--border);color:var(--text);font-family:monospace;font-size:12px;border-radius:9px;padding:10px;outline:none;resize:vertical;margin-top:8px;}
.cfg-textarea:focus{border-color:var(--blue)}
.cfg-textarea::placeholder{color:var(--muted)}
.setup-row{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
.setup-input{flex:1;min-width:120px;background:var(--navy4);border:1px solid var(--border);color:var(--text);font-family:var(--font);font-size:13px;font-weight:700;border-radius:9px;padding:9px 12px;outline:none;}
.setup-input:focus{border-color:var(--blue)}
.setup-input::placeholder{color:var(--muted)}
.setup-btn{background:linear-gradient(135deg,var(--blue),#0288d1);color:#fff;font-family:var(--font);font-size:13px;font-weight:800;border:none;border-radius:9px;padding:10px 18px;cursor:pointer;white-space:nowrap;}
.setup-btn.ghost{background:var(--navy3);border:1px solid var(--border);color:var(--text)}
.setup-btn.danger{background:rgba(255,80,80,0.12);border:1px solid rgba(255,80,80,0.3);color:var(--red)}
.cfg-err{font-size:12px;color:var(--red);font-weight:700;margin-top:6px;display:none}
.cfg-err.show{display:block}
.setup-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:14px}
.skip-link{background:transparent;border:none;color:var(--muted);font-family:var(--font);font-size:12px;cursor:pointer;text-decoration:underline;padding:4px}
.connected-box{background:rgba(105,240,174,0.06);border:1px solid rgba(105,240,174,0.28);border-radius:12px;padding:14px 15px;margin-bottom:13px}
.connected-title{font-weight:800;font-size:14px;color:var(--green);margin-bottom:10px}
.hid-row{display:flex;align-items:center;gap:8px;background:var(--navy4);border:1px solid var(--border);border-radius:8px;padding:8px 12px;margin:8px 0}
.hid-val{font-family:monospace;font-size:13px;color:var(--yellow);flex:1;word-break:break-all}
.copy-btn{background:var(--navy3);border:1px solid var(--border);color:var(--muted);font-family:var(--font);font-size:10px;font-weight:700;border-radius:6px;padding:4px 8px;cursor:pointer;white-space:nowrap;flex-shrink:0}
.no-kid{text-align:center;padding:60px 20px;color:var(--muted)}
.no-kid h2{font-family:var(--display);font-size:22px;color:var(--text);margin-bottom:8px}
.no-kid p{font-size:13px;margin-bottom:20px}
.no-kid button{background:linear-gradient(135deg,var(--blue),#0288d1);color:#fff;font-family:var(--font);font-size:14px;font-weight:800;border:none;border-radius:12px;padding:12px 24px;cursor:pointer}
.install-banner{display:none;background:linear-gradient(135deg,rgba(79,195,247,0.1),rgba(179,136,255,0.07));border:1px solid rgba(79,195,247,0.28);border-radius:13px;padding:11px 13px;gap:9px;align-items:center;}
.install-banner.show{display:flex}
.install-banner p{flex:1;font-size:12px;font-weight:600;color:var(--text);line-height:1.4}
.install-banner p b{color:var(--blue)}
.install-btn{background:var(--blue);color:#0a2030;font-family:var(--font);font-size:12px;font-weight:800;border:none;border-radius:8px;padding:7px 12px;cursor:pointer;flex-shrink:0}
.install-dismiss{background:transparent;border:none;color:var(--muted);font-size:16px;cursor:pointer;padding:2px 4px;flex-shrink:0}
@keyframes burst{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0}}
.confetti{position:fixed;width:7px;height:7px;border-radius:2px;animation:burst .55s ease forwards;pointer-events:none;z-index:9999}
</style>
</head>
<body>

<header class="hdr">
  <div class="hdr-inner">
    <div class="logo">&#x2605; Chore <b>Quest</b></div>
    <div class="kid-scroller" id="kidScroller"></div>
    <button class="btn-add-kid" id="btnAddKid">+ Kid</button>
    <div class="hdr-right">
      <div class="sync-pill" id="syncPill"><div class="sync-dot" id="syncDot"></div><span id="syncLabel">Local only</span></div>
      <button class="icon-btn" id="btnDB" title="Cloud Sync">&#x2601;&#xFE0F;</button>
      <button class="icon-btn" id="btnSummary" title="Weekly Summary">&#x1F4CA;</button>
      <button class="icon-btn" id="btnSettings" title="Settings">&#x2699;&#xFE0F;</button>
    </div>
  </div>
</header>

<div class="content" id="contentArea">

  <div id="noKidMsg" class="no-kid" style="display:none">
    <h2>&#x1F44B; Welcome to<br>Chore Quest!</h2>
    <p>Add a kid to start tracking chores and tokens.</p>
    <button id="btnAddKidBig">+ Add First Kid</button>
  </div>

  <!-- CHORES TAB -->
  <div class="tab-pane active" id="paneChores">
    <div id="installBanner" class="install-banner">
      <p>Add <b>Chore Quest</b> to your home screen!</p>
      <button class="install-btn" id="btnInstall">Install</button>
      <button class="install-dismiss" id="btnDismissInstall">&#x2715;</button>
    </div>
    <div class="section" id="secDaily">
      <div class="sec-hdr" onclick="toggleSection('secDaily')">
        <div class="sec-title"><div class="dot" style="background:var(--blue);box-shadow:0 0 7px var(--blue)"></div>&#x2600;&#xFE0F; Daily Tasks<span class="collapse-icon"></span></div>
        <button class="btn-add" id="btnAddDaily" onclick="event.stopPropagation()">+ Add</button>
      </div>
      <div class="sec-body" id="listDaily"></div>
      <div class="sec-tip">Tap day buttons to set schedule. Greyed out = not today.</div>
    </div>
    <div class="section" id="secBonus">
      <div class="sec-hdr" onclick="toggleSection('secBonus')">
        <div class="sec-title"><div class="dot" style="background:var(--yellow);box-shadow:0 0 7px var(--yellow)"></div>&#x26A1; Bonus Chores<span class="collapse-icon"></span></div>
        <button class="btn-add" id="btnAddBonus" onclick="event.stopPropagation()">+ Add</button>
      </div>
      <div class="sec-body" id="listBonus"></div>
    </div>
  </div>

  <!-- REWARDS TAB -->
  <div class="tab-pane" id="paneRewards">
    <div class="section" id="secRewards">
      <div class="sec-hdr" onclick="toggleSection('secRewards')">
        <div class="sec-title"><div class="dot" style="background:var(--purple);box-shadow:0 0 7px var(--purple)"></div>&#x1F381; Rewards<span class="collapse-icon"></span></div>
        <button class="btn-add" id="btnAddReward" onclick="event.stopPropagation()">+ Add</button>
      </div>
      <div class="sec-body" id="listRewards"></div>
    </div>
  </div>

  <!-- WALLET TAB -->
  <div class="tab-pane" id="paneWallet">
    <div class="wallet-hero">
      <div class="kid-label" id="kidLabel">Token Balance</div>
      <div class="tok-top">
        <div class="tok-coin"><div class="tok-num" id="tokNum">0</div><div class="tok-lbl">TOKENS</div></div>
        <div class="streak-box" id="streakBox">
          <div class="s-fire" id="sFire">&#x1F4A4;</div>
          <div class="s-num" id="sNum">0</div>
          <div class="s-lbl">Day Streak</div>
          <div class="s-best" id="sBest">best: 0</div>
        </div>
      </div>
      <div class="goal-box">
        <div class="goal-pick-row">
          <span class="goal-pick-label">From rewards</span>
          <select class="goal-select" id="goalRewardPick"><option value="">&#x2014; pick a reward &#x2014;</option></select>
        </div>
        <div class="goal-divider"><span>or custom goal</span></div>
        <div class="goal-row">
          <span class="goal-icon">&#x1F3AF;</span>
          <input class="goal-name" id="goalName" type="text" placeholder="Savings goal name&#x2026;"/>
          <div class="goal-target"><span>/ </span><input id="goalTarget" type="number" min="1" value="100"/><span style="color:var(--yellow)">&#9733;</span></div>
        </div>
        <div class="goal-track"><div class="goal-fill" id="goalFill" style="width:0%"></div></div>
        <div class="goal-pct" id="goalPct">0 / 100 tokens (0%)</div>
      </div>
    </div>
    <div class="manual-card">
      <div class="manual-label">Manual Adjustments</div>
      <div class="manual-row">
        <input class="m-amt" id="mAmt" type="number" placeholder="0" min="0" inputmode="numeric"/>
        <input class="m-note" id="mNote" type="text" placeholder="Note (optional)"/>
        <button class="m-add" id="btnMAdd">+Add</button>
        <button class="m-rem" id="btnMRem">&#x2212;Sub</button>
        <button class="m-undo" id="btnMUndo">&#x21A9; Undo</button>
      </div>
    </div>
    <div class="section" id="secHistory">
      <div class="sec-hdr" onclick="toggleSection('secHistory')">
        <div class="sec-title">&#x1F4DC; History<span class="collapse-icon"></span></div>
        <button class="clear-btn" id="btnClearHist" onclick="event.stopPropagation()">Clear</button>
      </div>
      <div class="hist-feed sec-body" id="histFeed"></div>
    </div>
  </div>

  <!-- STATS TAB -->
  <div class="tab-pane" id="paneStats">
    <div class="section" id="secCharts">
      <div class="sec-hdr" onclick="toggleSection('secCharts')">
        <div class="sec-title">&#x1F4C8; Charts<span class="collapse-icon"></span></div>
      </div>
      <div class="charts-body sec-body">
        <div class="chart-lbl">Last 7 Days &#x2014; Earned</div>
        <div class="chart-wrap"><canvas id="wChart"></canvas></div>
        <div class="chart-lbl">Last 12 Months &#x2014; Earned</div>
        <div class="chart-wrap"><canvas id="mChart"></canvas></div>
      </div>
    </div>
    <div class="section" id="secRedemptions">
      <div class="sec-hdr" onclick="toggleSection('secRedemptions')">
        <div class="sec-title">&#x1F381; Redemptions<span class="collapse-icon"></span></div>
      </div>
      <div class="charts-body sec-body">
        <div class="chart-lbl">Last 7 Days &#x2014; Redeemed</div>
        <div class="chart-wrap"><canvas id="wRChart"></canvas></div>
        <div class="chart-lbl">Last 12 Months &#x2014; Redeemed</div>
        <div class="chart-wrap"><canvas id="mRChart"></canvas></div>
      </div>
    </div>
  </div>

</div>

<nav class="tabbar">
  <button class="tab active" data-pane="paneChores"><span class="tab-icon">&#x2705;</span><span>Chores</span></button>
  <button class="tab" data-pane="paneRewards"><span class="tab-icon">&#x1F381;</span><span>Rewards</span></button>
  <button class="tab" data-pane="paneWallet"><span class="tab-icon">&#x2B50;</span><span>Wallet</span></button>
  <button class="tab" data-pane="paneStats"><span class="tab-icon">&#x1F4C8;</span><span>Stats</span></button>
</nav>

<!-- SUMMARY SHEET -->
<div class="overlay" id="summaryOverlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-hdr"><div class="sheet-title">&#x1F4CA; This Week</div><button class="sheet-close" id="btnSumClose">&#x2715;</button></div>
    <div class="sheet-body" id="sumBody"></div>
  </div>
</div>

<!-- SETTINGS SHEET -->
<div class="overlay" id="settingsOverlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-hdr"><div class="sheet-title">&#x2699;&#xFE0F; Settings</div><button class="sheet-close" id="btnSettingsClose">&#x2715;</button></div>
    <div class="sheet-body">
      <div class="setting-row" id="setExport">
        <span class="setting-icon">&#x2B07;&#xFE0F;</span>
        <div class="setting-info"><div class="setting-label">Export Data</div><div class="setting-desc">Download a backup JSON file</div></div>
      </div>
      <div class="setting-row" id="setImport">
        <span class="setting-icon">&#x2B06;&#xFE0F;</span>
        <div class="setting-info"><div class="setting-label">Import Data</div><div class="setting-desc">Restore from a backup file</div></div>
      </div>
      <div class="setting-row danger" id="setReset">
        <span class="setting-icon">&#x21BA;</span>
        <div class="setting-info"><div class="setting-label">Reset Everything</div><div class="setting-desc">Delete all kids, chores and history</div></div>
      </div>
    </div>
  </div>
</div>

<!-- DATABASE SHEET -->
<div class="overlay" id="dbOverlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-hdr"><div class="sheet-title">&#x2601;&#xFE0F; Cloud Database</div><button class="sheet-close" id="btnDBClose">&#x2715;</button></div>
    <div class="sheet-body">
      <div class="connected-box" id="connectedBox" style="display:none">
        <div class="connected-title">&#x2714; Connected to Firebase</div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:8px">Your data syncs in real-time. Share your Household ID to link another device.</p>
        <p style="font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:0">Household ID</p>
        <div class="hid-row"><span class="hid-val" id="connectedHID"></span><button class="copy-btn" id="btnCopyHID">Copy</button></div>
        <button class="setup-btn danger" id="btnDisconnect" style="margin-top:4px">Disconnect</button>
      </div>
      <div id="setupForm">
        <div class="setup-steps">
          <div class="setup-step">
            <div class="step-head"><div class="step-num">1</div><div class="step-title">Create a free Firebase project</div></div>
            <p>Go to <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a> &rarr; <strong>Add project</strong>. Disable Analytics when asked.</p>
          </div>
          <div class="setup-step">
            <div class="step-head"><div class="step-num">2</div><div class="step-title">Add a Web App &amp; paste config</div></div>
            <p>Click the <code>&lt;/&gt;</code> icon &rarr; register with any nickname. Paste the full <code>firebaseConfig { &hellip; }</code> object here:</p>
            <textarea class="cfg-textarea" id="fbConfigInput" placeholder='{&#10;  "apiKey": "AIzaSy...",&#10;  "authDomain": "your-app.firebaseapp.com",&#10;  "projectId": "your-app",&#10;  "storageBucket": "your-app.appspot.com",&#10;  "messagingSenderId": "123456",&#10;  "appId": "1:123:web:abc"&#10;}'></textarea>
            <div class="cfg-err" id="cfgErr">Invalid config &mdash; paste the full { ... } object from Firebase.</div>
          </div>
          <div class="setup-step">
            <div class="step-head"><div class="step-num">3</div><div class="step-title">Enable Firestore Database</div></div>
            <p>Firebase Console &rarr; <strong>Build &rarr; Firestore Database &rarr; Create database</strong>. Choose <strong>Start in test mode</strong>, pick any region, click Enable.</p>
          </div>
          <div class="setup-step">
            <div class="step-head"><div class="step-num">4</div><div class="step-title">Set your Household ID</div></div>
            <p>Links all your devices together. Generate one, or type your own. Use the exact same ID on every device you want to sync.</p>
            <div class="setup-row">
              <input class="setup-input" id="householdInput" placeholder="e.g. smith-family-2024"/>
              <button class="setup-btn ghost" id="btnGenHID">Generate</button>
            </div>
          </div>
        </div>
        <div class="setup-actions">
          <button class="setup-btn" id="btnConnectDB">Connect &amp; Sync</button>
          <button class="skip-link" id="btnSkipDB">Skip &mdash; keep local only</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* â”€â”€ CONSTANTS â”€â”€ */
const SK='choreQuestV2';
const DAY_LABELS=['S','M','T','W','T','F','S'];
const DAY_NAMES=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const ALL_DAYS=[0,1,2,3,4,5,6];
const MONSAT=[1,2,3,4,5,6];

const GRP_ICON={daily:'ðŸ§¼',monsat:'ðŸ§º',bonus:'âš¡'};
const GRP_DEF={daily:ALL_DAYS,monsat:MONSAT,bonus:ALL_DAYS};
const CC={green:'#69f0ae',yellow:'#ffd740',blue:'#4fc3f7',orange:'#ffb74d',red:'#ff6b6b'};

let _uidc=0;
function uid(){return Date.now()+'_'+(++_uidc)+'_'+Math.random().toString(36).slice(2,5);}

function mkKid(name){return{id:uid(),name:name||'Kid',daily:[],monsat:[],bonus:[],rewards:[],tokens:[],streakDates:[],bestStreak:0,goal:{name:'',target:100}};}
function mkChore(g){return{id:uid(),title:'',tokens:1,lastDone:null,completions:[],days:[...GRP_DEF[g]]};}
function mkReward(){return{id:uid(),title:'',cost:5};}

/* â”€â”€ STATE â”€â”€ */
let S;
function load(){try{const r=localStorage.getItem(SK);return r?JSON.parse(r):{kids:[],activeId:null};}catch(e){return{kids:[],activeId:null};}}

/* â•â• FIREBASE â•â• */
let db=null, fbUnsub=null, saveTimer=null, ownWrite=false;

function setSyncUI(cls,label){
  const p=document.getElementById('syncPill');
  p.className='sync-pill'+(cls?' '+cls:'');
  document.getElementById('syncLabel').textContent=label;
}

function connectFirebase(cfg,hid){
  try{
    firebase.apps.slice().forEach(a=>a.delete().catch(()=>{}));
    firebase.initializeApp(cfg);
    db=firebase.firestore();
    db.enablePersistence({synchronizeTabs:true}).catch(()=>{});
    localStorage.setItem('cq_fbcfg',JSON.stringify(cfg));
    localStorage.setItem('cq_hid',hid);
    startListener(hid);
    return true;
  }catch(e){console.error(e);db=null;return false;}
}

function startListener(hid){
  if(fbUnsub){fbUnsub();fbUnsub=null;}
  setSyncUI('syncing','Connectingâ€¦');
  fbUnsub=db.collection('chorequest').doc(hid).onSnapshot(snap=>{
    if(ownWrite)return;
    if(snap.exists){
      const remote=snap.data().data;
      if(remote&&JSON.stringify(remote)!==JSON.stringify(S)){S=remote;if(!S.kids)S.kids=[];saveLocal();renderAll();}
    }else{save();}
    setSyncUI('synced','Synced âœ“');
  },err=>{console.error(err);setSyncUI('error','Offline');});
}

function disconnectFirebase(){
  if(fbUnsub){fbUnsub();fbUnsub=null;}
  firebase.apps.slice().forEach(a=>a.delete().catch(()=>{}));
  db=null;localStorage.removeItem('cq_fbcfg');localStorage.removeItem('cq_hid');
  setSyncUI('','Local only');
}

// auto reconnect on load
(function(){
  const raw=localStorage.getItem('cq_fbcfg'),hid=localStorage.getItem('cq_hid');
  if(raw&&hid){try{connectFirebase(JSON.parse(raw),hid);}catch(e){localStorage.removeItem('cq_fbcfg');}}
})();

function saveLocal(){localStorage.setItem(SK,JSON.stringify(S));}
function save(){
  saveLocal();
  if(!db)return;
  clearTimeout(saveTimer);
  setSyncUI('syncing','Savingâ€¦');
  saveTimer=setTimeout(async()=>{
    try{
      ownWrite=true;
      await db.collection('chorequest').doc(localStorage.getItem('cq_hid')).set({data:S,ts:firebase.firestore.FieldValue.serverTimestamp()});
      setSyncUI('synced','Synced âœ“');
    }catch(e){console.error(e);setSyncUI('error','Sync error');}
    finally{setTimeout(()=>{ownWrite=false;},600);}
  },700);
}
S=(()=>{try{const r=localStorage.getItem(SK);return r?JSON.parse(r):{kids:[],activeId:null};}catch(e){return{kids:[],activeId:null};}})();
if(!S.kids)S.kids=[];
function kid(){return S.kids.find(k=>k.id===S.activeId)||S.kids[0]||null;}

/* â”€â”€ UTILS â”€â”€ */
function dateStr(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function todayStr(){const d=new Date();return dateStr(d);}
function todayDow(){return new Date().getDay();}
function tokenSum(k){return(k.tokens||[]).reduce((s,e)=>s+Number(e.amount||0),0);}
function timeAgo(ts){const ms=Date.now()-ts,h=ms/3600000,d=ms/86400000;if(ms<60000)return'Just now';if(h<1)return Math.floor(ms/60000)+'m ago';if(h<24)return Math.floor(h)+'h ago';if(d<7)return Math.floor(d)+'d ago';return new Date(ts).toLocaleDateString(undefined,{month:'short',day:'numeric'});}
function scheduledToday(c){return(c.days||ALL_DAYS).includes(todayDow());}
function calcStreak(k){
  const set=new Set(k.streakDates||[]);if(!set.size)return 0;
  const today=todayStr();let cur=new Date(),streak=0;
  if(!set.has(today))cur.setDate(cur.getDate()-1);
  while(true){const ds=dateStr(cur);if(set.has(ds)){streak++;cur.setDate(cur.getDate()-1);}else break;}
  return streak;
}
function refreshStreak(k){
  const today=todayStr();
  const sched=k.daily.filter(c=>scheduledToday(c));
  const allDone=sched.length>0&&sched.every(c=>c.lastDone===today);
  if(!k.streakDates)k.streakDates=[];
  if(allDone){if(!k.streakDates.includes(today))k.streakDates.push(today);}
  else k.streakDates=k.streakDates.filter(d=>d!==today);
  const s=calcStreak(k);if(s>(k.bestStreak||0))k.bestStreak=s;
}

/* â”€â”€ CONFETTI â”€â”€ */
function confetti(x,y){
  const cols=['#4fc3f7','#69f0ae','#ffd740','#ff6b9d','#b388ff','#ffb74d'];
  for(let i=0;i<14;i++){
    const el=document.createElement('div');el.className='confetti';
    const ang=Math.random()*360,dist=45+Math.random()*65;
    const tx=Math.cos(ang*Math.PI/180)*dist,ty=Math.sin(ang*Math.PI/180)*dist-30;
    el.style.cssText=`left:${x-3}px;top:${y-3}px;background:${cols[i%cols.length]};--tx:${tx}px;--ty:${ty}px`;
    document.body.appendChild(el);setTimeout(()=>el.remove(),650);
  }
}

/* â”€â”€ KID TABS â”€â”€ */
function renderTabs(){
  const ct=document.getElementById('kidScroller');ct.innerHTML='';
  S.kids.forEach(k=>{
    const tab=document.createElement('div');
    tab.className='kid-tab'+(k.id===S.activeId?' active':'');
    const inp=document.createElement('input');
    inp.type='text';inp.value=k.name||'';inp.placeholder='Nameâ€¦';
    inp.addEventListener('click',e=>e.stopPropagation());
    inp.addEventListener('input',e=>{k.name=e.target.value;save();renderRight();});
    const del=document.createElement('button');del.textContent='âœ•';del.title='Remove kid';
    del.addEventListener('click',e=>{e.stopPropagation();removeKid(k.id);});
    tab.appendChild(inp);tab.appendChild(del);
    tab.addEventListener('click',()=>{S.activeId=k.id;save();renderAll();});
    ct.appendChild(tab);
  });
}
function addKid(){const k=mkKid('Kid '+(S.kids.length+1));S.kids.push(k);S.activeId=k.id;save();renderAll();}
function removeKid(id){
  if(S.kids.length<=1){alert("Can't remove the last kid!");return;}
  if(!confirm('Remove '+( S.kids.find(k=>k.id===id)?.name||'this kid')+' and all their data?'))return;
  S.kids=S.kids.filter(k=>k.id!==id);
  if(S.activeId===id)S.activeId=S.kids[0]?.id||null;
  save();renderAll();
}

/* â”€â”€ CHORE CARD â”€â”€ */
function buildChoreCard(grp,idx,item,k){
  const today=todayStr(),dow=todayDow();
  const done=item.lastDone===today,sched=scheduledToday(item);
  const card=document.createElement('div');
  card.className='chore-card'+(done?' done-today':'')+(!sched&&!done?' off-day':'');
  card.draggable=true;
  card.addEventListener('dragstart',e=>{e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',idx);card.classList.add('dragging');});
  card.addEventListener('dragend',()=>card.classList.remove('dragging'));
  card.addEventListener('dragover',e=>{e.preventDefault();card.classList.add('drag-over');});
  card.addEventListener('dragleave',()=>card.classList.remove('drag-over'));
  card.addEventListener('drop',e=>{
    e.preventDefault();card.classList.remove('drag-over');
    const from=Number(e.dataTransfer.getData('text/plain'));
    const to=idx;if(from===to)return;
    const arr=k[grp];const [moved]=arr.splice(from,1);arr.splice(to,0,moved);
    save();renderAll();
  });
  const row=document.createElement('div');row.className='chore-row';
  const handle=document.createElement('div');handle.className='drag-handle';handle.textContent='â ¿';handle.title='Drag to reorder';
  const icon=document.createElement('div');icon.className='c-icon';icon.textContent=GRP_ICON[grp]||'âœ…';
  const name=document.createElement('input');name.className='c-name'+(done?' struck':'');
  name.type='text';name.value=item.title;name.placeholder='Task nameâ€¦';
  name.addEventListener('input',e=>{item.title=e.target.value;save();});
  const tb=document.createElement('div');tb.className='tok-badge';tb.innerHTML='<span style="font-size:10px;color:#ffd740">â˜…</span>';
  const ti=document.createElement('input');ti.type='number';ti.value=item.tokens;ti.min=0;
  ti.addEventListener('input',e=>{item.tokens=Number(e.target.value||0);save();});
  tb.appendChild(ti);
  const chk=document.createElement('button');chk.className='check-btn'+(done?' ticked':'');
  chk.textContent=done?'âœ“':'';chk.title=done?'Done today!':sched?'Mark done':'Not scheduled today';
  if(!sched&&!done)chk.setAttribute('disabled','');
  chk.addEventListener('click',e=>{
    if(item.lastDone===today)return;
    item.lastDone=today;
    if(!item.completions)item.completions=[];
    if(!item.completions.includes(today))item.completions.push(today);
    k.tokens.unshift({amount:Number(item.tokens||0),note:(item.title||'Task')+' ('+grp+')',timestamp:Date.now()});
    refreshStreak(k);save();
    const r=chk.getBoundingClientRect();confetti(r.left+r.width/2,r.top+r.height/2);
    renderAll();
  });
  const undo=document.createElement('button');undo.className='ic-btn undo';undo.title='Undo today';undo.textContent='â†©';
  undo.addEventListener('click',()=>{
    if(item.lastDone!==today)return;
    item.lastDone=null;
    if(item.completions)item.completions=item.completions.filter(d=>d!==today);
    k.tokens.unshift({amount:-Number(item.tokens||0),note:'Undo: '+(item.title||'Task'),timestamp:Date.now()});
    refreshStreak(k);save();renderAll();
  });
  const del=document.createElement('button');del.className='ic-btn del';del.title='Delete';del.textContent='ðŸ—‘';
  del.addEventListener('click',()=>{k[grp].splice(idx,1);save();renderAll();});
  row.appendChild(handle);row.appendChild(icon);row.appendChild(name);row.appendChild(tb);row.appendChild(chk);row.appendChild(undo);row.appendChild(del);
  card.appendChild(row);
  const dp=document.createElement('div');dp.className='day-row';
  DAY_LABELS.forEach((lbl,d)=>{
    const b=document.createElement('button');
    b.className='day-btn'+(item.days.includes(d)?' on':'')+(d===dow?' today-ring':'');
    b.textContent=lbl;b.title=DAY_NAMES[d];
    b.addEventListener('click',()=>{
      if(item.days.includes(d)){if(item.days.length>1)item.days=item.days.filter(x=>x!==d);}
      else item.days=[...item.days,d].sort((a,b)=>a-b);
      save();renderAll();
    });
    dp.appendChild(b);
  });
  if(!sched){const note=document.createElement('span');note.className='off-label';note.textContent='not today';dp.appendChild(note);}
  card.appendChild(dp);
  return card;
}

/* â”€â”€ REWARD ROW â”€â”€ */
function buildRewardRow(idx,item,k){
  const row=document.createElement('div');row.className='reward-row';
  row.draggable=true;
  row.addEventListener('dragstart',e=>{e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',idx);row.classList.add('dragging');});
  row.addEventListener('dragend',()=>row.classList.remove('dragging'));
  row.addEventListener('dragover',e=>{e.preventDefault();row.classList.add('drag-over');});
  row.addEventListener('dragleave',()=>row.classList.remove('drag-over'));
  row.addEventListener('drop',e=>{
    e.preventDefault();row.classList.remove('drag-over');
    const from=Number(e.dataTransfer.getData('text/plain'));
    const to=idx;if(from===to)return;
    const [moved]=k.rewards.splice(from,1);k.rewards.splice(to,0,moved);
    save();renderAll();
  });
  const handle=document.createElement('div');handle.className='drag-handle';handle.textContent='â ¿';handle.title='Drag to reorder';
  const icon=document.createElement('span');icon.style.fontSize='16px';icon.textContent='ðŸŽ';
  const name=document.createElement('input');name.className='r-name';name.type='text';name.value=item.title;name.placeholder='Reward nameâ€¦';
  name.addEventListener('input',e=>{item.title=e.target.value;save();});
  const cb=document.createElement('div');cb.className='cost-badge';cb.innerHTML='<span style="font-size:10px;color:#ffd740">â˜…</span>';
  const ci=document.createElement('input');ci.type='number';ci.min=0;ci.value=item.cost;
  ci.addEventListener('input',e=>{item.cost=Number(e.target.value||0);save();});
  cb.appendChild(ci);
  const rdm=document.createElement('button');rdm.className='redeem-btn';rdm.textContent='Redeem';
  rdm.addEventListener('click',()=>{
    if(tokenSum(k)<item.cost){rdm.textContent='Not enough!';setTimeout(()=>rdm.textContent='Redeem',1500);return;}
    k.tokens.unshift({amount:-item.cost,note:'ðŸŽ '+(item.title||'Reward'),timestamp:Date.now()});
    save();renderAll();
  });
  const del=document.createElement('button');del.className='ic-btn del';del.title='Delete';del.textContent='ðŸ—‘';
  del.addEventListener('click',()=>{k.rewards.splice(idx,1);save();renderAll();});
  row.appendChild(handle);row.appendChild(icon);row.appendChild(name);row.appendChild(cb);row.appendChild(rdm);row.appendChild(del);
  return row;
}

/* â”€â”€ RENDER LEFT (chores + rewards) â”€â”€ */
function renderLeft(){
  const k=kid();
  [['daily','listDaily'],['bonus','listBonus']].forEach(([g,id])=>{
    const ct=document.getElementById(id);ct.innerHTML='';
    if(k)k[g].forEach((item,i)=>ct.appendChild(buildChoreCard(g,i,item,k)));
  });
  const rct=document.getElementById('listRewards');rct.innerHTML='';
  if(k)k.rewards.forEach((r,i)=>rct.appendChild(buildRewardRow(i,r,k)));
}

/* â”€â”€ RENDER RIGHT (wallet, history, charts) â”€â”€ */
function renderRight(){
  const k=kid();
  const tot=k?tokenSum(k):0;
  document.getElementById('tokNum').textContent=tot;
  document.getElementById('kidLabel').textContent=k&&k.name?k.name+"'s Balance":'Token Balance';
  const streak=k?calcStreak(k):0,best=k?k.bestStreak||0:0;
  document.getElementById('sFire').textContent=streak>0?'ðŸ”¥':'ðŸ’¤';
  document.getElementById('sNum').textContent=streak;
  document.getElementById('sBest').textContent='best: '+best;
  document.getElementById('streakBox').className='streak-box'+(streak===0?' no-streak':'');
  if(k){
    const g=k.goal||{name:'',target:100,rewardId:null};
    if(g.rewardId){
      const r=(k.rewards||[]).find(r=>r.id===g.rewardId);
      if(r){g.name=r.title||'';g.target=r.cost||1;}
      else{g.rewardId=null;}
    }
    const sel=document.getElementById('goalRewardPick');
    sel.innerHTML='<option value="">â€” pick a reward â€”</option>';
    (k.rewards||[]).forEach(r=>{
      const opt=document.createElement('option');
      opt.value=r.id;opt.textContent=(r.title||'Unnamed reward')+' ('+r.cost+' â˜…)';
      sel.appendChild(opt);
    });
    sel.value=g.rewardId||'';
    document.getElementById('goalName').value=g.name||'';
    document.getElementById('goalTarget').value=g.target||100;
    const pct=g.target>0?Math.min(100,Math.round(tot/g.target*100)):0;
    document.getElementById('goalFill').style.width=pct+'%';
    document.getElementById('goalPct').textContent=tot+' / '+g.target+' tokens ('+pct+'%)';
  }
  const feed=document.getElementById('histFeed');feed.innerHTML='';
  if(!k||!k.tokens||!k.tokens.length){feed.innerHTML='<div class="hist-empty">No events yet. Complete a chore! âœ¨</div>';}
  else{k.tokens.slice(0,60).forEach(ev=>{
    const item=document.createElement('div');item.className='hist-item';
    const amt=document.createElement('div');amt.className='h-amt '+(ev.amount>=0?'pos':'neg');amt.textContent=(ev.amount>=0?'+':'')+ev.amount;
    const note=document.createElement('div');note.className='h-note';note.textContent=ev.note||'';
    const time=document.createElement('div');time.className='h-time';time.textContent=timeAgo(ev.timestamp);
    item.appendChild(amt);item.appendChild(note);item.appendChild(time);feed.appendChild(item);
  });}
  renderCharts(k);
}

/* â”€â”€ CHARTS â”€â”€ */
Chart.defaults.color='#6b7fa3';Chart.defaults.font.family="'Nunito',sans-serif";Chart.defaults.font.weight='700';
let wC,mC,wRC,mRC;
function renderCharts(k){
  const wL=[],wT=[],wRT=[],today=new Date();
  for(let i=6;i>=0;i--){const d=new Date(today);d.setDate(today.getDate()-i);wL.push(d.toLocaleDateString(undefined,{weekday:'short'}));wT.push(0);wRT.push(0);}
  const wS=new Date();wS.setDate(today.getDate()-6);wS.setHours(0,0,0,0);
  if(k)(k.tokens||[]).forEach(ev=>{
    const t=Number(ev.amount||0),ts=new Date(ev.timestamp);
    if(ts<wS)return;
    const diff=Math.floor((new Date(ev.timestamp).setHours(0,0,0,0)-wS.getTime())/86400000);
    if(diff<0||diff>=7)return;
    if((ev.note||'').startsWith('ðŸŽ'))wRT[diff]+=Math.abs(t);
    else wT[diff]+=t;
  });
  const mL=[],mT=[],mRT=[],months=[],now=new Date();
  for(let i=11;i>=0;i--){const d=new Date(now.getFullYear(),now.getMonth()-i,1);mL.push(d.toLocaleDateString(undefined,{month:'short'}));months.push({y:d.getFullYear(),m:d.getMonth()});mT.push(0);mRT.push(0);}
  if(k)(k.tokens||[]).forEach(ev=>{
    const t=Number(ev.amount||0),d=new Date(ev.timestamp);
    for(let i=0;i<months.length;i++){
      if(d.getFullYear()===months[i].y&&d.getMonth()===months[i].m){
        if((ev.note||'').startsWith('ðŸŽ'))mRT[i]+=Math.abs(t);
        else mT[i]+=t;
        break;
      }
    }
  });
  const tt={backgroundColor:'#141c2e',borderColor:'#2a3854',borderWidth:1,callbacks:{label:t=>` ${t.formattedValue} tokens`}};
  const scl={y:{beginAtZero:true,grid:{color:'rgba(42,56,84,0.45)'},ticks:{color:'#6b7fa3',font:{size:9}}},x:{grid:{display:false},ticks:{color:'#6b7fa3',font:{size:9}}}};
  if(wC)wC.destroy();
  wC=new Chart(document.getElementById('wChart').getContext('2d'),{type:'bar',data:{labels:wL,datasets:[{data:wT,backgroundColor:wT.map(v=>v>=0?'rgba(105,240,174,0.78)':'rgba(255,107,107,0.78)'),borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:tt},scales:scl}});
  if(mC)mC.destroy();
  mC=new Chart(document.getElementById('mChart').getContext('2d'),{type:'line',data:{labels:mL,datasets:[{data:mT,fill:true,backgroundColor:'rgba(79,195,247,0.07)',borderColor:'rgba(79,195,247,0.9)',pointBackgroundColor:'rgba(79,195,247,1)',tension:0.4,pointRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:tt},scales:scl}});
  if(wRC)wRC.destroy();
  wRC=new Chart(document.getElementById('wRChart').getContext('2d'),{type:'bar',data:{labels:wL,datasets:[{data:wRT,backgroundColor:'rgba(179,136,255,0.78)',borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:tt},scales:scl}});
  if(mRC)mRC.destroy();
  mRC=new Chart(document.getElementById('mRChart').getContext('2d'),{type:'line',data:{labels:mL,datasets:[{data:mRT,fill:true,backgroundColor:'rgba(179,136,255,0.07)',borderColor:'rgba(179,136,255,0.9)',pointBackgroundColor:'rgba(179,136,255,1)',tension:0.4,pointRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:tt},scales:scl}});
}

/* â”€â”€ RENDER ALL â”€â”€ */
function renderAll(){
  const k=kid(),has=!!k;
  document.getElementById('noKidMsg').style.display=has?'none':'block';
  const tb=document.querySelector('.tabbar');if(tb)tb.style.display=has?'flex':'none';
  renderTabs();
  if(has){renderLeft();renderRight();}
}

/* â”€â”€ SUMMARY â”€â”€ */
function openSummary(){
  const k=kid();if(!k){alert('Add a kid first!');return;}
  const body=document.getElementById('sumBody');body.innerHTML='';
  const today=new Date(),dow=today.getDay(),dfm=(dow+6)%7;
  const wS=new Date(today);wS.setDate(today.getDate()-dfm);wS.setHours(0,0,0,0);
  const wE=new Date(today);wE.setHours(23,59,59,999);
  const dayMap={};let earned=0,redeemed=0;
  for(let i=0;i<=dfm;i++){const d=new Date(wS);d.setDate(wS.getDate()+i);dayMap[dateStr(d)]=0;}
  (k.tokens||[]).forEach(ev=>{const d=new Date(ev.timestamp),ds=dateStr(d),v=Number(ev.amount||0);if(d>=wS&&d<=wE){if(v>0){earned+=v;if(ds in dayMap)dayMap[ds]+=v;}else if((ev.note||'').startsWith('ðŸŽ'))redeemed+=Math.abs(v);}});
  const best=Object.entries(dayMap).sort((a,b)=>b[1]-a[1])[0];
  const bLbl=best?new Date(best[0]+'T12:00').toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'})+' (+'+best[1]+')':'â€”';
  const streak=calcStreak(k);
  const period=document.createElement('div');period.className='sum-period';period.textContent=(k.name||'Kid')+' Â· '+wS.toLocaleDateString(undefined,{month:'short',day:'numeric'})+' â€“ '+today.toLocaleDateString(undefined,{month:'short',day:'numeric'});
  body.appendChild(period);
  const grid=document.createElement('div');grid.className='stat-grid';
  [{v:'+'+earned,kk:'Earned',c:CC.green},{v:'-'+redeemed,kk:'Redeemed',c:CC.red},{v:(earned-redeemed>=0?'+':'')+(earned-redeemed),kk:'Net',c:CC.yellow},
   {v:bLbl,kk:'Best Day',c:CC.blue,sm:true},{v:streak+'ðŸ”¥',kk:'Streak',c:CC.orange},{v:(k.bestStreak||0)+'ðŸ†',kk:'Best Ever',c:CC.yellow}
  ].forEach(s=>{
    const c=document.createElement('div');c.className='stat-card';
    const vv=document.createElement('div');vv.className='stat-val';vv.style.color=s.c;vv.style.fontSize=s.sm?'13px':'22px';vv.textContent=s.v;
    const kk=document.createElement('div');kk.className='stat-key';kk.textContent=s.kk;
    c.appendChild(vv);c.appendChild(kk);grid.appendChild(c);
  });
  body.appendChild(grid);
  const allC=[];
  ['daily','monsat','bonus'].forEach(grp=>{
    (k[grp]||[]).forEach(c=>{
      let possible=0;
      for(let i=0;i<=dfm;i++){const d=new Date(wS);d.setDate(wS.getDate()+i);if((c.days||ALL_DAYS).includes(d.getDay()))possible++;}
      const done=(c.completions||[]).filter(ds=>{const d=new Date(ds+'T12:00');return d>=wS&&d<=wE;}).length;
      if(possible>0)allC.push({name:c.title||'Untitled',done,possible,pct:Math.round(done/possible*100)});
    });
  });
  if(allC.length){
    const t=document.createElement('div');t.className='sum-sec';t.textContent='Chore Completion';body.appendChild(t);
    allC.sort((a,b)=>b.pct-a.pct).forEach(c=>{
      const r=document.createElement('div');r.className='cs-row';
      const n=document.createElement('div');n.className='cs-name';n.textContent=c.name;
      const tr=document.createElement('div');tr.className='cs-track';
      const fi=document.createElement('div');fi.className='cs-fill';fi.style.width=c.pct+'%';tr.appendChild(fi);
      const pct=document.createElement('div');pct.className='cs-pct';pct.style.color=c.pct>=80?CC.green:c.pct>=50?CC.yellow:CC.red;pct.textContent=c.pct+'%';
      const frac=document.createElement('div');frac.className='cs-frac';frac.textContent=c.done+'/'+c.possible;
      r.appendChild(n);r.appendChild(tr);r.appendChild(pct);r.appendChild(frac);body.appendChild(r);
    });
  }
  document.getElementById('summaryOverlay').classList.add('open');
}

/* â”€â”€ COLLAPSE â”€â”€ */
const ALL_SECTIONS=['secDaily','secBonus','secRewards','secHistory','secCharts','secRedemptions'];
function toggleSection(id){document.getElementById(id).classList.toggle('collapsed');}
document.addEventListener('keydown',e=>{
  if(e.key!=='Escape')return;
  const openModal=document.querySelector('.overlay.open');
  if(openModal){openModal.classList.remove('open');return;}
  const allCollapsed=ALL_SECTIONS.every(id=>document.getElementById(id)?.classList.contains('collapsed'));
  ALL_SECTIONS.forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    if(allCollapsed)el.classList.remove('collapsed');
    else el.classList.add('collapsed');
  });
});

/* â”€â”€ TAB SWITCHING â”€â”€ */
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const pane=document.getElementById(t.dataset.pane);
  if(pane)pane.classList.add('active');
  document.getElementById('contentArea').scrollTop=0;
  // refresh charts when switching to stats tab
  if(t.dataset.pane==='paneStats')renderRight();
}));

/* â”€â”€ WIRE EVENTS â”€â”€ */
document.getElementById('btnAddKid').addEventListener('click',addKid);
document.getElementById('btnAddKidBig').addEventListener('click',addKid);
document.getElementById('btnAddDaily').addEventListener('click',()=>{const k=kid();if(!k)return;k.daily.push(mkChore('daily'));save();renderAll();});
document.getElementById('btnAddBonus').addEventListener('click',()=>{const k=kid();if(!k)return;k.bonus.push(mkChore('bonus'));save();renderAll();});
document.getElementById('btnAddReward').addEventListener('click',()=>{const k=kid();if(!k)return;k.rewards.push(mkReward());save();renderAll();});
document.getElementById('btnMAdd').addEventListener('click',()=>{const k=kid();if(!k)return;const v=Number(document.getElementById('mAmt').value||0);if(!v)return;const n=document.getElementById('mNote').value.trim();k.tokens.unshift({amount:v,note:n||'Manual add',manual:true,timestamp:Date.now()});document.getElementById('mAmt').value='';document.getElementById('mNote').value='';save();renderAll();});
document.getElementById('btnMRem').addEventListener('click',()=>{const k=kid();if(!k)return;const v=Number(document.getElementById('mAmt').value||0);if(!v)return;const n=document.getElementById('mNote').value.trim();k.tokens.unshift({amount:-v,note:n||'Manual subtract',manual:true,timestamp:Date.now()});document.getElementById('mAmt').value='';document.getElementById('mNote').value='';save();renderAll();});
document.getElementById('btnMUndo').addEventListener('click',()=>{
  const k=kid();if(!k)return;
  const b=document.getElementById('btnMUndo');
  const idx=k.tokens.findIndex(e=>e.manual===true);
  if(idx===-1){b.textContent='Nothing to undo';setTimeout(()=>b.textContent='â†© Undo',1500);return;}
  k.tokens.splice(idx,1);save();renderAll();
  b.textContent='Undone!';setTimeout(()=>b.textContent='â†© Undo',1200);
});
document.getElementById('btnClearHist').addEventListener('click',()=>{const k=kid();if(!k)return;if(!confirm('Clear token history?'))return;k.tokens=[];save();renderAll();});
document.getElementById('goalRewardPick').addEventListener('change',e=>{
  const k=kid();if(!k)return;
  if(!k.goal)k.goal={name:'',target:100,rewardId:null};
  const rid=e.target.value;
  if(rid){const r=(k.rewards||[]).find(r=>r.id===rid);if(r){k.goal.rewardId=rid;k.goal.name=r.title||'';k.goal.target=r.cost||1;}}
  else{k.goal.rewardId=null;}
  save();renderRight();
});
document.getElementById('goalName').addEventListener('input',e=>{
  const k=kid();if(!k)return;
  if(!k.goal)k.goal={name:'',target:100,rewardId:null};
  k.goal.name=e.target.value;k.goal.rewardId=null;
  document.getElementById('goalRewardPick').value='';
  save();
});
document.getElementById('goalTarget').addEventListener('input',e=>{
  const k=kid();if(!k)return;
  if(!k.goal)k.goal={name:'',target:100,rewardId:null};
  k.goal.target=Math.max(1,Number(e.target.value||1));k.goal.rewardId=null;
  document.getElementById('goalRewardPick').value='';
  save();renderRight();
});
document.getElementById('btnSummary').addEventListener('click',openSummary);
document.getElementById('btnSumClose').addEventListener('click',()=>document.getElementById('summaryOverlay').classList.remove('open'));
document.getElementById('summaryOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('open');});

/* â”€â”€ SETTINGS SHEET â”€â”€ */
document.getElementById('btnSettings').addEventListener('click',()=>document.getElementById('settingsOverlay').classList.add('open'));
document.getElementById('btnSettingsClose').addEventListener('click',()=>document.getElementById('settingsOverlay').classList.remove('open'));
document.getElementById('settingsOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('open');});
document.getElementById('setExport').addEventListener('click',()=>{const k=kid();const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=(k?.name?.trim()||'chore')+'-quest.json';a.click();});
document.getElementById('setImport').addEventListener('click',()=>{const inp=document.createElement('input');inp.type='file';inp.accept='application/json';inp.addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const reader=new FileReader();reader.addEventListener('load',ev=>{try{const data=JSON.parse(ev.target.result);if(data.daily&&!data.kids){const k=mkKid(data.childName||'Imported');k.daily=data.daily||[];k.monsat=data.monsat||[];k.bonus=data.bonus||[];k.rewards=data.rewards||[];k.tokens=data.tokens||[];S={kids:[k],activeId:k.id};}else{S={kids:data.kids||[],activeId:data.activeId||data.kids?.[0]?.id||null};}save();renderAll();document.getElementById('settingsOverlay').classList.remove('open');}catch(err){alert('Invalid JSON file.');}});reader.readAsText(f);});inp.click();});
document.getElementById('setReset').addEventListener('click',()=>{if(!confirm('Reset everything?'))return;S={kids:[],activeId:null};save();renderAll();document.getElementById('settingsOverlay').classList.remove('open');});

/* â”€â”€ DB SHEET â”€â”€ */
function openDBModal(){
  const connected=!!db;
  document.getElementById('connectedBox').style.display=connected?'block':'none';
  document.getElementById('setupForm').style.display=connected?'none':'block';
  if(connected){document.getElementById('connectedHID').textContent=localStorage.getItem('cq_hid')||'';}
  else{const raw=localStorage.getItem('cq_fbcfg');if(raw)document.getElementById('fbConfigInput').value=JSON.stringify(JSON.parse(raw),null,2);const hid=localStorage.getItem('cq_hid');if(hid)document.getElementById('householdInput').value=hid;}
  document.getElementById('dbOverlay').classList.add('open');
}
document.getElementById('btnDB').addEventListener('click',openDBModal);
document.getElementById('btnDBClose').addEventListener('click',()=>document.getElementById('dbOverlay').classList.remove('open'));
document.getElementById('dbOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('open');});
document.getElementById('btnGenHID').addEventListener('click',()=>{document.getElementById('householdInput').value='cq-'+Math.random().toString(36).slice(2,7)+'-'+Math.random().toString(36).slice(2,7);});
document.getElementById('btnConnectDB').addEventListener('click',()=>{
  const raw=document.getElementById('fbConfigInput').value.trim();
  const hid=document.getElementById('householdInput').value.trim();
  const err=document.getElementById('cfgErr');err.classList.remove('show');
  if(!hid){alert('Please enter or generate a Household ID.');return;}
  let cfg;
  try{
    let c=raw.replace(/\/\/.*$/gm,'').replace(/,\s*([}\]])/g,'$1').replace(/([{,]\s*)(\w+)\s*:/g,'$1"$2":').replace(/'/g,'"');
    cfg=JSON.parse(c.startsWith('{')?c:raw);
    if(!cfg.apiKey||!cfg.projectId)throw new Error();
  }catch(e){err.classList.add('show');return;}
  if(connectFirebase(cfg,hid)){document.getElementById('dbOverlay').classList.remove('open');}
  else{err.textContent='Connection failed â€” check config and try again.';err.classList.add('show');}
});
document.getElementById('btnSkipDB').addEventListener('click',()=>document.getElementById('dbOverlay').classList.remove('open'));
document.getElementById('btnDisconnect').addEventListener('click',()=>{if(!confirm('Disconnect from cloud?'))return;disconnectFirebase();document.getElementById('dbOverlay').classList.remove('open');});
document.getElementById('btnCopyHID').addEventListener('click',()=>{navigator.clipboard.writeText(localStorage.getItem('cq_hid')||'').then(()=>{const b=document.getElementById('btnCopyHID');b.textContent='Copied!';setTimeout(()=>b.textContent='Copy',1500);});});

/* â”€â”€ PWA INSTALL BANNER â”€â”€ */
let deferredInstall=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();deferredInstall=e;
  document.getElementById('installBanner').classList.add('show');
});
document.getElementById('btnInstall').addEventListener('click',async()=>{
  if(!deferredInstall)return;
  deferredInstall.prompt();
  const{outcome}=await deferredInstall.userChoice;
  deferredInstall=null;
  document.getElementById('installBanner').classList.remove('show');
});
document.getElementById('btnDismissInstall').addEventListener('click',()=>{
  document.getElementById('installBanner').classList.remove('show');
});
window.addEventListener('appinstalled',()=>document.getElementById('installBanner').classList.remove('show'));

/* â”€â”€ SERVICE WORKER â”€â”€ */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));
}

/* â”€â”€ BOOT â”€â”€ */
if(S.kids.length===0){const k=mkKid('Kid 1');S.kids=[k];S.activeId=k.id;save();}
if(!S.activeId)S.activeId=S.kids[0]?.id||null;
renderAll();
</script>
</body>
</html>
